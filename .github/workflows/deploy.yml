name: Deploy to EC2 via Docker Compose
on:
  push:
    branches:
      - main
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. 소스코드 체크아웃
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. Docker Hub 로그인
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 3. Docker 이미지 빌드 및 Docker Hub에 푸시
      - name: Build and Push Docker Images
        run: |
          # 백엔드 이미지 빌드 및 푸시 (FastAPI) - 경로 명시 및 현재 컨텍스트 사용
          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/skn16-fastapi:latest -f Dockerfile .
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/skn16-fastapi:latest

          # 프론트엔드 이미지 빌드 및 푸시 (Nginx) - ./frontend 디렉토리를 컨텍스트로 사용
          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/skn16-frontend:latest ./frontend
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/skn16-frontend:latest
        env:
          DOCKER_BUILDKIT: 1

      # 4. SSH를 사용하여 EC2 서버에 접속 및 배포 명령 실행
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            # 프로젝트 디렉토리로 이동 (디렉토리 이름 확인 필수: SKN16-FINAL-4Team)
            cd SKN16-FINAL-4Team

            # Docker Hub에 다시 로그인 (EC2에서 pull 받기 위함)
            docker login -u ${{ secrets.DOCKERHUB_USERNAME }} -p ${{ secrets.DOCKERHUB_TOKEN }}

            # 최신 이미지 다운로드 및 Docker Compose 환경 재시작
            docker-compose pull
            docker-compose up -d --no-build

            # DB 마이그레이션 실행
            docker exec fastapi-prod python -m alembic upgrade head
